#_ECHO_OFF
DEMO_DELAY=10

#dclean
docker ps -a -q | xargs -n1 docker stop; docker system prune -af
docker volume prune -f

pack set-default-builder gcr.io/paketo-buildpacks/builder:base-platform-api-0.3

cd ${DEMO_TEMP}
if [ ! -d go-demo-app ]; then git clone git@github.com:ciberkleid/hello-go.git go-demo-app; fi

IMG=registry.gitlab.com/andreasevers/echo-service/cnb-config
pack inspect-image $IMG > inspect.txt
pack inspect-image $IMG --bom > inspect-bom.json

cd ${DEMO_TEMP}/go-demo-app/src
cp ../Dockerfiles/Dockerfile-6 ../Dockerfile
pack build go-demo-img

clear
#_ECHO_ON

##_ECHO_# Sample app
ls
#go run hello.go world

#clear
##_ECHO_# Dockerfile (docker build -t my-img)
bat ../Dockerfile

##_ECHO_# Buildpacks (platform + lifecycle + base images + buildpacks)
pack inspect-builder gcr.io/paketo-buildpacks/builder:base-platform-api-0.3
# pack set-default-builder gcr.io/paketo-buildpacks/builder:base-platform-api-0.3
clear
pack build go-demo-img --no-pull
docker images
#docker run go-demo-img hello world

##_ECHO_# GitLab Demo
# GitLab Demo
# Open https://gitlab.com/andreasevers/echo-service
# cnb-config branch
# show gitlab ci yaml file
# Sets JVM version, includes maven tests, uses custom buildpack
# Go to CI/CD Pipelines, click Run Pipeline
# Show log - show that log is similar to pack demo (detection of bps, phases)
# Point out Paketo for Java highlights: Java memory calculator, env variable for config, the URLs to the GitHub repos and docs, ... ???)
# Show customizations: JVM 14 and custom buildpack
# Show line saying image final name
# Show https://gitlab.com/gitlab-org/cluster-integration/auto-build-image/-/blob/master/src/build.sh#L20

clear
#_ECHO_OFF
docker pull $IMG > /dev/null
docker pull paketobuildpacks/run:0.0.61-base-cnb > /dev/null
#_ECHO_ON

#_ECHO_# Transparency
echo $IMG
pack inspect-image $IMG --bom > inspect-bom.json

# open inspect-bom.json in chrome with JSON Viewer Extension; show jdk/jre, dependencies...

#_ECHO_# OS patching
docker pull $IMG
docker pull paketobuildpacks/run:0.0.61-base-cnb
docker tag paketobuildpacks/run:0.0.61-base-cnb paketobuildpacks/run:base-cnb
docker images
OLD_ID=
pack rebase $IMG --no-pull
catd <(docker inspect $OLD_ID) <(docker inspect $IMG) | tail -n31
